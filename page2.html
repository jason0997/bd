<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ—¥å¿«ä¹å¹èœ¡çƒ›æ¸¸æˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDNï¼Œç”¨äºæ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¸º Inter å­—ä½“è®¾ç½®ä¸€ä¸ªå›é€€ï¼Œç¡®ä¿åœ¨ä»»ä½•è®¾å¤‡ä¸Šéƒ½èƒ½æœ‰è‰¯å¥½çš„æ˜¾ç¤º */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* å®šä¹‰åŠ¨ç”»æ•ˆæœï¼Œä¸æ¸¸æˆä¸­çš„ Tailwind ç±»å¯¹åº” */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-5%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
        @keyframes bounce-slow {
            0%, 100% {
                transform: translateY(-5%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite; /* æ…¢é€Ÿå¼¹è·³ */
        }
        .animate-fade-in-up {
            animation: fadeInScale 0.5s ease-out forwards; /* å¼¹çª—æ·¡å…¥æ”¾å¤§æ•ˆæœ */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 p-4">
    <!-- æ¸¸æˆå†…å®¹å¡ç‰‡ -->
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full text-center">
        <!-- ç”Ÿæ—¥ç¥ç¦æ ‡é¢˜ -->
        <h1 class="text-4xl font-bold text-gray-800 mb-4 animate-bounce">
            ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‰
        </h1>

        <!-- è›‹ç³•å’Œèœ¡çƒ›çš„ Canvas å®¹å™¨ -->
        <div class="relative w-full max-w-md mx-auto aspect-video mb-6">
            <canvas id="birthdayCanvas" class="w-full h-full border-4 border-yellow-400 rounded-lg shadow-inner bg-blue-100"></canvas>
        </div>

        <!-- ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <p id="messageDisplay" class="text-xl font-semibold mb-6 text-gray-700">
            è¯·å°è¯•å¹ç­èœ¡çƒ›ï¼
        </p>
    </div>

    <!-- æ¡ä»¶æ¸²æŸ“ï¼šâ€œç”Ÿæ—¥å¿«ä¹â€å¼¹çª— -->
    <div id="birthdayPopup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-yellow-100 p-8 rounded-xl shadow-2xl text-center border-4 border-yellow-500 animate-fade-in-up">
            <p class="text-5xl font-extrabold text-red-600 mb-6 drop-shadow-lg animate-bounce-slow">
                ç”Ÿæ—¥å¿«ä¹ï¼
            </p>
            <p class="text-3xl font-semibold text-gray-800">
                ç¥æ‚¨ç”Ÿæ—¥å¿«ä¹ï¼Œå¹¸ç¦å®‰åº·ï¼
            </p>
            <button id="popupResetButton" class="mt-8 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-300">
                ä¸‹ä¸€é¡µ
            </button>
        </div>
    </div>

    <script>
        // è·å– DOM å…ƒç´ 
        const canvas = document.getElementById('birthdayCanvas');
        const ctx = canvas.getContext('2d');
        const messageDisplay = document.getElementById('messageDisplay');
        const birthdayPopup = document.getElementById('birthdayPopup');
        const popupResetButton = document.getElementById('popupResetButton');

        // æ¸¸æˆçŠ¶æ€å˜é‡
        let candlesLit = true;
        let isMicActive = false;
        let isGameEnded = false;
        let micAccessGranted = false;

        // éŸ³é¢‘ç›¸å…³å˜é‡
        let audioContext = null;
        let analyser = null;
        let micStream = null;
        let animationFrameId = null;

        // å¹æ°”é˜ˆå€¼ (å›ºå®šå€¼)
        const BLOW_THRESHOLD_FIXED = 50; // æ ¹æ®ä¹‹å‰çš„è¯·æ±‚ï¼Œçµæ•åº¦è°ƒæ•´ä¸º 50
        const SAMPLE_SIZE = 128;

        // ç»˜åˆ¶è›‹ç³•å’Œèœ¡çƒ›çš„å¸¸é‡é¢œè‰²
        const CAKE_BODY_COLOR = '#F5B041';
        const CAKE_SHADOW_COLOR = '#C38B27';
        const ICING_COLOR_TOP = '#FFD700';
        const ICING_COLOR_MIDDLE = '#FFC300';
        const CANDLE_COLOR_BASE = '#FF6F61';
        const CANDLE_COLOR_STRIPE = '#FFC0CB';
        const FLAME_COLOR_INNER = '#FFFF00';
        const FLAME_COLOR_OUTER = '#FF8C00';
        const WICK_COLOR = '#8B4513';
        const TABLE_COLOR = '#8B4513';

        // -------------------- ç»˜å›¾å‡½æ•° --------------------

        // ç»˜åˆ¶ç”Ÿæ—¥è›‹ç³•
        function drawCake(ctx, width, height) {
            ctx.clearRect(0, 0, width, height);

            const cakeHeight = height * 0.4;
            const cakeWidth = width * 0.7;
            const cakeX = (width - cakeWidth) / 2;
            const cakeY = height - cakeHeight - 20;

            ctx.fillStyle = TABLE_COLOR;
            ctx.fillRect(0, height - 50, width, 50);

            const layerHeight = cakeHeight / 2;
            ctx.fillStyle = CAKE_BODY_COLOR;
            ctx.beginPath();
            ctx.ellipse(cakeX + cakeWidth / 2, cakeY + cakeHeight / 2 + layerHeight / 2, cakeWidth / 2, layerHeight / 2, 0, Math.PI, 2 * Math.PI, false);
            ctx.rect(cakeX, cakeY + cakeHeight / 2, cakeWidth, layerHeight);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = ICING_COLOR_MIDDLE;
            ctx.beginPath();
            ctx.ellipse(cakeX + cakeWidth / 2, cakeY + cakeHeight / 2, cakeWidth / 2, layerHeight * 0.2, 0, 0, 2 * Math.PI);
            ctx.fill();

            const topCakeWidth = cakeWidth * 0.8;
            const topCakeX = cakeX + (cakeWidth - topCakeWidth) / 2;
            const topCakeY = cakeY;
            ctx.fillStyle = CAKE_BODY_COLOR;
            ctx.beginPath();
            ctx.ellipse(topCakeX + topCakeWidth / 2, topCakeY + layerHeight / 2, topCakeWidth / 2, layerHeight / 2, 0, Math.PI, 2 * Math.PI, false);
            ctx.rect(topCakeX, topCakeY, topCakeWidth, layerHeight);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = ICING_COLOR_TOP;
            ctx.beginPath();
            ctx.ellipse(topCakeX + topCakeWidth / 2, topCakeY + layerHeight / 2, topCakeWidth / 2, layerHeight * 0.2, 0, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = CAKE_SHADOW_COLOR;
            ctx.beginPath();
            ctx.ellipse(cakeX + cakeWidth / 2, cakeY + cakeHeight + 5, cakeWidth / 2, cakeHeight * 0.05, 0, 0, 2 * Math.PI);
            ctx.fill();

            ctx.strokeStyle = ICING_COLOR_TOP;
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let i = 0; i <= 20; i++) {
                const x = topCakeX + (topCakeWidth / 20) * i;
                const y = topCakeY + layerHeight / 2 + (i % 2 === 0 ? -5 : 5);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.beginPath();
            for (let i = 0; i <= 20; i++) {
                const x = cakeX + (cakeWidth / 20) * i;
                const y = cakeY + cakeHeight / 2 + (i % 2 === 0 ? -5 : 5);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        // ç»˜åˆ¶èœ¡çƒ› (ç‚¹äº®æˆ–ç†„ç­çŠ¶æ€)
        function drawCandles(ctx, lit, width, height) {
            const cakeWidth = width * 0.7;
            const topCakeWidth = cakeWidth * 0.8;
            const topCakeX = (width - topCakeWidth) / 2;
            const topCakeY = height * 0.6 - 20;

            const candleCount = 6;
            const candleWidth = topCakeWidth / (candleCount * 1.5);
            const candleHeight = height * 0.18;

            for (let i = 0; i < candleCount; i++) {
                const candleX = topCakeX + (i + 0.5) * (topCakeWidth / candleCount) - candleWidth / 2;
                const candleY = topCakeY - candleHeight + 10;

                ctx.fillStyle = CANDLE_COLOR_BASE;
                ctx.fillRect(candleX, candleY, candleWidth, candleHeight);

                ctx.fillStyle = CANDLE_COLOR_STRIPE;
                for (let j = 0; j < 3; j++) {
                    ctx.fillRect(candleX, candleY + candleHeight / 4 + j * (candleHeight / 4), candleWidth, candleHeight / 10);
                }

                ctx.fillStyle = WICK_COLOR;
                ctx.fillRect(candleX + candleWidth / 2 - 1, candleY - 5, 2, 8);

                if (lit) {
                    ctx.beginPath();
                    ctx.ellipse(candleX + candleWidth / 2, candleY - 12, candleWidth / 2.5, candleWidth * 0.7, 0, 0, 2 * Math.PI);
                    ctx.fillStyle = FLAME_COLOR_OUTER;
                    ctx.fill();

                    ctx.beginPath();
                    ctx.ellipse(candleX + candleWidth / 2, candleY - 12, candleWidth / 4, candleWidth * 0.4, 0, 0, 2 * Math.PI);
                    ctx.fillStyle = FLAME_COLOR_INNER;
                    ctx.fill();
                }
            }
        }

        // ä¸»å‡½æ•°ï¼šç»˜åˆ¶æ•´ä¸ªåœºæ™¯ (è›‹ç³•å’Œèœ¡çƒ›)
        function drawScene() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            drawCake(ctx, rect.width, rect.height);
            drawCandles(ctx, candlesLit, rect.width, rect.height);
        }

        // -------------------- éŸ³é¢‘å¤„ç†å‡½æ•° --------------------

        // åœæ­¢éº¦å…‹é£è¾“å…¥å’ŒéŸ³é¢‘å¤„ç†
        function stopBlowing() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            if (audioContext) {
                if (audioContext.state !== 'closed') {
                    audioContext.close().catch(e => console.error("å…³é—­ AudioContext é”™è¯¯:", e));
                }
                audioContext = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isMicActive = false;
        }

        // æŒç»­åˆ†æéº¦å…‹é£éŸ³é¢‘è¾“å…¥
        function analyzeAudio() {
            if (!analyser || !candlesLit || isGameEnded || !micAccessGranted) {
                animationFrameId = null;
                return;
            }

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            for (let i = 0; i < SAMPLE_SIZE; i++) {
                sum += dataArray[i];
            }
            const average = sum / SAMPLE_SIZE;

            if (average > BLOW_THRESHOLD_FIXED) {
                candlesLit = false;
                messageDisplay.textContent = "ç”Ÿæ—¥å¿«ä¹ï¼";
                messageDisplay.classList.add('text-green-600', 'animate-pulse');
                messageDisplay.classList.remove('text-gray-700');
                isGameEnded = true;
                stopBlowing();
                birthdayPopup.classList.remove('hidden'); // æ˜¾ç¤ºå¼¹çª—
            } else {
                animationFrameId = requestAnimationFrame(analyzeAudio);
            }
            drawScene(); // æ¯æ¬¡éŸ³é¢‘åˆ†æåé‡æ–°ç»˜åˆ¶ï¼Œä»¥æ›´æ–°èœ¡çƒ›çŠ¶æ€
        }

        // å¼€å§‹è®¿é—®éº¦å…‹é£å¹¶å¼€å§‹éŸ³é¢‘åˆ†æ
        async function startBlowing() {
            if (isMicActive || (micAccessGranted && !isGameEnded)) return;

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                const source = audioContext.createMediaStreamSource(micStream);
                source.connect(analyser);

                isMicActive = true;
                micAccessGranted = true;
                messageDisplay.textContent = "è¯·å°è¯•å¹ç­èœ¡çƒ›ï¼";
                messageDisplay.classList.remove('text-green-600', 'animate-pulse');
                messageDisplay.classList.add('text-gray-700');
                animationFrameId = requestAnimationFrame(analyzeAudio);
            } catch (err) {
                console.error("è®¿é—®éº¦å…‹é£é”™è¯¯:", err);
                messageDisplay.textContent = "æ— æ³•è®¿é—®éº¦å…‹é£ã€‚è¯·æˆäºˆæƒé™ä»¥å¹ç­èœ¡çƒ›ã€‚";
                isMicActive = false;
                micAccessGranted = false;
            }
            drawScene(); // é‡æ–°ç»˜åˆ¶åœºæ™¯ä»¥æ›´æ–°ä¿¡æ¯
        }

        // -------------------- æ¸¸æˆé€»è¾‘å‡½æ•° --------------------

        // è¿™ä¸ªå‡½æ•°ç”¨äºé‡ç½®æ¸¸æˆçŠ¶æ€ï¼Œä½†ç°åœ¨å®ƒä¸ä¼šè¢«å¤–éƒ¨æŒ‰é’®ç›´æ¥è°ƒç”¨
        function resetGameInternal() {
            stopBlowing();
            candlesLit = true;
            messageDisplay.textContent = "è¯·å°è¯•å¹ç­èœ¡çƒ›ï¼";
            messageDisplay.classList.remove('text-green-600', 'animate-pulse');
            messageDisplay.classList.add('text-gray-700');
            isGameEnded = false;
            birthdayPopup.classList.add('hidden'); // éšè—å¼¹çª—

            if (!micAccessGranted) {
                startBlowing(); // å¦‚æœä¹‹å‰æœªæˆäºˆæƒé™ï¼Œåˆ™å†æ¬¡å°è¯•è·å–
            } else {
                isMicActive = true;
                animationFrameId = requestAnimationFrame(analyzeAudio);
            }
            drawScene(); // é‡ç½®åé‡æ–°ç»˜åˆ¶åœºæ™¯
        }

        // -------------------- åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬ --------------------

        // çª—å£åŠ è½½æ—¶åˆå§‹åŒ–æ¸¸æˆ
        window.onload = function() {
            drawScene(); // åˆå§‹ç»˜åˆ¶
            startBlowing(); // å°è¯•è·å–éº¦å…‹é£æƒé™å¹¶å¼€å§‹æ¸¸æˆ

            // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–ï¼Œé‡æ–°ç»˜åˆ¶ canvas
            window.addEventListener('resize', drawScene);

            // â€œä¸‹ä¸€é¡µâ€æŒ‰é’®äº‹ä»¶ç›‘å¬ - æ˜ç¡®è·³è½¬åˆ° index.html
            popupResetButton.addEventListener('click', function() {
                window.location.href = 'index.html'; // æ˜ç¡®è·³è½¬åˆ°å½“å‰ç›®å½•ä¸‹çš„ index.html
            });
        };
    </script>
</body>
</html>
