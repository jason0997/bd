<div class="game-container flex flex-col justify-center items-center min-h-screen">
    <div id="loading-overlay">
        <div id="loading-text">Ê≠£Âú®Âä†ËΩΩÁÖßÁâá...</div>
        <div class="spinner"></div>
    </div>
    
    <div id="slideshow-container" class="rounded-lg">
        <img id="slideshow-image-1" class="slideshow-image rounded-lg" alt="Ê≠£Âú®Âä†ËΩΩÁÖßÁâá...">
        <img id="slideshow-image-2" class="slideshow-image rounded-lg" alt="Ê≠£Âú®Âä†ËΩΩÁÖßÁâá...">
    </div>
    
    <div id="shou-character-grid-container" class="rounded-lg">
        <h1 class="text-4xl font-bold text-gray-800 mb-4 animate-bounce">
            ÁîüÊó•Âø´‰πêÔºÅüéâ
        </h1>
        </div>
    <div id="controls"></div>

    <script>
        const slideshowContainer = document.getElementById('slideshow-container');
        const shouGridContainer = document.getElementById('shou-character-grid-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const slideshowImage1 = document.getElementById('slideshow-image-1');
        const slideshowImage2 = document.getElementById('slideshow-image-2');

        let activeImageElement = slideshowImage1;
        let inactiveImageElement = slideshowImage2;

        const imageUrls = [
            './img/1.jpeg',
            './img/2.jpeg',
            './img/3.jpeg',
            './img/4.jpeg',
            './img/5.jpeg',
            './img/6.jpeg',
            './img/7.jpeg',
            './img/8.jpeg',
            './img/9.jpeg',
            './img/10.jpeg',
            './img/11.jpeg',
            './img/12.jpeg',
            './img/13.jpeg',
            './img/14.jpeg',
            './img/15.jpeg',
            './img/16.jpeg',
            './img/17.jpeg',
            './img/18.jpeg'
        ];

        let currentImageIndex = 0;
        let slideshowCounter = 0;
        const totalSlides = imageUrls.length;
        const displayDuration = 2000;
        const fadeDuration = 800;
        
        const shouPixelMap = `
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000110000000000000000000000000
        00000000000000000000001110000000000000000000000000
        00000000000000000000001110000000000000000000000000
        00000000001111111111111111111111111111110000000000
        00000000001111111111111111111111111111110000000000
        00000000000000000000001110000000000000000000000000
        00000000000000000000001100000000000000000000000000
        00000000000000000000001100000000000000000000000000
        00000000000000000000011110000000000000000000000000
        00000000000111111111111111111111111111000000000000
        00000000000011111111111111111111111111000000000000
        00000000000000000000011000000000000000000000000000
        00000000000000000000011000000000000000000000000000
        00000000000000000000111000000000000000000000000000
        00000000111111111111111111111111111111111100000000
        00000000111111111111111111111111111111111100000000
        00000000000000000001110000000000111000000000000000
        00000000000000000001100000000000110000000000000000
        00000000000000000011100000000000110000000000000000
        00000000000000000111000000000000110000000000000000
        00000000000000000111000000000000111000000000000000
        00000000000000001111111111111111111111111000000000
        00000000000000011111111111111111111111111000000000
        00000000000000111100000000000000111000000000000000
        00000000000000111000000000000000110000000000000000
        00000000000011110000000000000000110000000000000000
        00000000000111100001000000000000110000000000000000
        00000000001111000011110000000000110000000000000000
        00000000111110000000111100000000110000000000000000
        00000001111000000000001111000000110000000000000000
        00000000110000000000000111000000110000000000000000
        00000000000000000000000000000000110000000000000000
        00000000000000000000000000000000110000000000000000
        00000000000000000000000000100001110000000000000000
        00000000000000000000000000111111110000000000000000
        00000000000000000000000000011110000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000
        00000000000000000000000000000000000000000000000000`.trim();

        const shouRows = shouPixelMap.split('\n').map(row => row.trim());
        const shouHeight = shouRows.length;
        const shouWidth = shouRows[0].length;

        function showNextImage() {
            if (slideshowCounter >= totalSlides - 1) {
                clearInterval(slideshowInterval);
                setTimeout(transitionToShouCharacter, displayDuration - fadeDuration);
                return;
            }
            slideshowCounter++;
            let nextImageToDisplayIndex = (currentImageIndex + 1) % totalSlides;
            inactiveImageElement.src = imageUrls[nextImageToDisplayIndex];

            activeImageElement.classList.remove('active');
            activeImageElement.classList.add('inactive');

            inactiveImageElement.classList.remove('inactive');
            inactiveImageElement.classList.add('active');

            setTimeout(() => {
                const temp = activeImageElement;
                activeImageElement = inactiveImageElement;
                inactiveImageElement = temp;
                currentImageIndex = nextImageToDisplayIndex;
            }, 500);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function adjustShouGridSize() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const gridPadding = 10;
            const gridGap = 1;

            const availableWidthForCells = viewportWidth - (2 * gridPadding) - ((shouWidth - 1) * gridGap);
            const availableHeightForCells = viewportHeight - (2 * gridPadding) - ((shouHeight - 1) * gridGap);
            const maxCellSizeFromWidth = availableWidthForCells / shouWidth;
            const maxCellSizeFromHeight = availableHeightForCells / shouHeight;
            const cellSize = Math.floor(Math.min(maxCellSizeFromWidth, maxCellSizeFromHeight));
            
            shouGridContainer.style.gridTemplateColumns = `repeat(${shouWidth}, ${cellSize}px)`;
            shouGridContainer.style.gridAutoRows = `${cellSize}px`;
            shouGridContainer.style.width = `${shouWidth * cellSize + (shouWidth - 1) * gridGap}px`;
            shouGridContainer.style.height = `${shouHeight * cellSize + (shouHeight - 1) * gridGap}px`;
            shouGridContainer.style.position = 'absolute';
            shouGridContainer.style.left = '50%';
            shouGridContainer.style.top = '50%';
            shouGridContainer.style.transform = 'translate(-50%, -50%)';
        }

        function transitionToShouCharacter() {
            slideshowContainer.style.opacity = 0;

            adjustShouGridSize();

            const cellsToReveal = [];

            for (let r = 0; r < shouHeight; r++) {
                for (let c = 0; c < shouWidth; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    if (shouRows[r][c] === '1') {
                        const randomImageIndex = Math.floor(Math.random() * imageUrls.length);
                        const img = document.createElement('img');
                        img.src = imageUrls[randomImageIndex];
                        img.alt = `ÂØøÂ≠óÂõæÁâá ${r}-${c}`;
                        cell.appendChild(img);
                        cellsToReveal.push({ img: img, row: r, col: c });
                    }
                    shouGridContainer.appendChild(cell);
                }
            }

            setTimeout(() => {
                slideshowContainer.style.display = 'none';
                shouGridContainer.style.opacity = 1;

                const revealStartDelay = 200;
                const revealStaggerDelay = 15;
                shuffleArray(cellsToReveal);
                cellsToReveal.forEach((cellData, index) => {
                    setTimeout(() => {
                        cellData.img.style.opacity = 1;
                    }, revealStartDelay + (index * revealStaggerDelay));
                });
            }, 200);
        }

        let slideshowInterval;

        function preloadImages(urls, callback) {
            let loadedCount = 0;
            const total = urls.length;
            if (total === 0) {
                callback();
                return;
            }
            urls.forEach(url => {
                const img = new Image();
                img.onload = () => {
                    loadedCount++;
                    if (loadedCount === total) {
                        callback();
                    }
                };
                img.onerror = () => {
                    loadedCount++;
                    console.error(`ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ${url}`);
                    if (loadedCount === total) {
                        callback();
                    }
                };
                img.src = url;
            });
        }

        function startSlideshow() {
            loadingOverlay.style.opacity = 0;
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                slideshowContainer.style.opacity = 1;
                activeImageElement.src = imageUrls[0];
                activeImageElement.classList.add('active');
                inactiveImageElement.classList.add('inactive');
                currentImageIndex = 0;
                slideshowCounter = 0;
                slideshowInterval = setInterval(showNextImage, displayDuration);
            }, 500);
        }

        // ‰øÆÊîπÊ≠§Â§ÑÔºöÂ∞ÜÂàùÂßãÂåñÈÄªËæëÂ∞ÅË£ÖÂà∞‰∏Ä‰∏™Êñ∞ÂáΩÊï∞‰∏≠Ôºå‰ª•‰æø‰ªé‰∏ªÈ°µÈù¢Ë∞ÉÁî®
        window.initPage3 = function() {
            // Ê∏ÖÁêÜÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®‰ª•Èò≤Ê≠¢ÈáçÂ§ç
            window.removeEventListener('resize', adjustShouGridSize);
            // ÈáçÊñ∞Ê∑ªÂä†ÁõëÂê¨Âô®
            window.addEventListener('resize', () => {
                if (shouGridContainer.style.opacity === '1') {
                    adjustShouGridSize();
                }
            });
            // È¢ÑÂä†ËΩΩÂõæÁâáÂπ∂ÂêØÂä®ÂπªÁÅØÁâá
            preloadImages(imageUrls, startSlideshow);
        };
    </script>
</div>
